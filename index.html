<script>
/* ==========================================================
   THEGRID — Patch v1.8  (Performance + Payments polish)
   - No auto-open Customize panel
   - GPU-friendly sparkles (replaces heavy confetti)
   - Strong section titles & separators
   - Payment cards: tier badges + “View details”
   - Safe: no external deps; removes itself cleanly
   ========================================================== */

(function () {
  const TAG = "THEGRID Patch v1.8";
  try {
    /* ---------- 0) Owner panel: never auto-open ---------- */
    // Older patches may have auto-opened the panel via a flag.
    localStorage.removeItem("tg_conf_open"); // hard stop
    // Only toggle when Customize is clicked:
    const customize = document.querySelector('[data-action="customize"], .tg-customize, button[aria-label="Customize"]');
    if (customize && !customize._tgWired) {
      customize._tgWired = true;
      customize.addEventListener("click", () => {
        document.documentElement.toggleAttribute("data-owner-open");
      });
    }

    /* ---------- 1) Section titles & separation ---------- */
    // Add a classy divider & stronger headings without touching markup
    const style = document.createElement("style");
    style.id = "tg-patch-18-style";
    style.textContent = `
      /* Headline lift */
      .tg-title,
      section h2,
      .pricing h2,
      [data-section-title] {
        letter-spacing:.2px;
        font-weight:800;
        position:relative;
        text-shadow:0 0 12px rgba(255,215,0,.15);
      }
      /* Section frame */
      .tg-section,
      section,
      .pricing {
        position:relative;
        isolation:isolate;
      }
      .tg-section::before,
      section::before,
      .pricing::before{
        content:"";
        position:absolute; inset: -2px;
        border-radius:18px;
        pointer-events:none;
        background:
          radial-gradient(120% 50% at 50% -10%, rgba(255,215,0,.22), transparent 60%) ,
          linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,0));
        box-shadow: 0 0 0 1px rgba(255,215,0,.18), inset 0 0 18px rgba(255,215,0,.08);
        z-index:-1;
      }
      /* Strong card headers inside Monetise */
      .pricing .card-title{
        font-weight:900;
        letter-spacing:.3px;
      }

      /* ---------- Sparkles (no-lag) ---------- */
      .tg-sparkles { position:absolute; inset:0; overflow:visible; pointer-events:none; }
      .tg-sparkles i {
        position:absolute; width:6px; height:6px; opacity:0; border-radius:50%;
        transform:translate3d(0,0,0);
        animation: tgPop .9s ease-out forwards;
        will-change: transform, opacity;
        filter: drop-shadow(0 0 6px currentColor);
      }
      .tg-sparkles i.sq { border-radius:2px; }
      .tg-sparkles i.shard { width:8px; height:3px; border-radius:2px; }
      .tg-sparkles i.star { width:7px; height:7px; clip-path:polygon(50% 0,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%)}

      @keyframes tgPop {
        0%   {opacity:0; transform: translate3d(var(--x,0), var(--y,0),0) scale(.6);}
        8%   {opacity:1;}
        100% {opacity:0; transform: translate3d(calc(var(--x,0) * 1.7), calc(var(--y,0) * 2.1),0) scale(.9);}
      }

      /* Tier badges & details link */
      .tg-badge {
        display:inline-flex; align-items:center; gap:.45rem;
        font:600 .85rem/1.15 var(--font-sans, ui-sans-serif);
        padding:.35rem .6rem; border-radius:999px;
        background: rgba(255,215,0,.10);
        border:1px solid rgba(255,215,0,.28);
      }
      .tg-badge svg{ width:16px; height:16px; }
      .tg-details { margin-top:.6rem; }
      .tg-details button{
        background:transparent; color:var(--text,#eaeaea);
        border:none; text-decoration:underline; font-weight:600;
      }
      .tg-details ul{ margin:.5rem 0 .3rem 1.1rem; display:none; }
      .tg-details[open] ul{ display:block; }
    `;
    document.head.appendChild(style);

    /* ---------- 2) Tier styling helpers ---------- */
    const TIERS = {
      basic:  { color:"#FBD76B", shape:"dot"   },
      silver: { color:"#C8D2E2", shape:"shard" },
      gold:   { color:"#FFD24D", shape:"sq"    },
      diamond:{ color:"#B9F2FF", shape:"star"  }
    };

    /* ---------- 3) Payment cards polish ---------- */
    const cards = document.querySelectorAll('.pricing [data-tier], .pricing .card, .pricing-card');
    cards.forEach((card) => {
      // Determine tier from data-tier OR text content fallback
      const txt = (card.getAttribute('data-tier') || card.textContent || "").toLowerCase();
      const tier = /diamond/.test(txt) ? "diamond"
                 : /gold/.test(txt)    ? "gold"
                 : /silver/.test(txt)  ? "silver"
                 : "basic";
      card.dataset.tier = tier;
      const {color} = TIERS[tier];

      // Badge
      if (!card.querySelector('.tg-badge')) {
        const badge = document.createElement('div');
        badge.className = 'tg-badge';
        badge.style.color = color;
        badge.innerHTML = `
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.86L18.18 22 12 18.77 5.82 22 7 14.13l-5-4.86 6.91-1.01L12 2z"/>
          </svg>
          ${tier[0].toUpperCase()+tier.slice(1)}
        `;
        const title = card.querySelector('.card-title, h3, h4') || card.firstElementChild;
        (title || card).prepend(badge);
      }

      // Details toggle (use existing bullet list if present)
      const bullets = card.querySelector('ul, .features') || null;
      if (bullets && !card.querySelector('.tg-details')) {
        const wrap = document.createElement('div');
        wrap.className = 'tg-details';
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = 'View details';
        btn.addEventListener('click', ()=> wrap.toggleAttribute('open'));
        wrap.appendChild(btn);
        bullets.parentNode.insertBefore(wrap, bullets);
        wrap.appendChild(bullets);
      }
    });

    /* ---------- 4) GPU sparkles (on view & on click) ---------- */
    function makeSparkles(host, tier="basic", count=22) {
      // Keep to small counts for perf on mobile
      const {color, shape} = TIERS[tier] || TIERS.basic;
      const box = document.createElement('div');
      box.className = 'tg-sparkles';
      for (let i=0;i<count;i++){
        const p = document.createElement('i');
        if (shape!=="dot") p.classList.add(shape);
        const angle = Math.random()*Math.PI*2;
        const r = 20 + Math.random()*80;
        p.style.setProperty('--x', (Math.cos(angle)*r) + 'px');
        p.style.setProperty('--y', (Math.sin(angle)*r) + 'px');
        p.style.color = color;
        p.style.left = (50 + (Math.random()*40-20)) + '%';
        p.style.top  = (50 + (Math.random()*20-10)) + '%';
        p.style.animationDelay = (Math.random()*0.25) + 's';
        box.appendChild(p);
      }
      host.style.position = 'relative';
      host.appendChild(box);
      setTimeout(()=> box.remove(), 1200); // auto-clean
    }

    // Once when a pricing card first becomes visible
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          const card = e.target;
          makeSparkles(card, card.dataset.tier || 'basic', 18);
          io.unobserve(card);
        }
      });
    }, {rootMargin:"0px 0px -10% 0px", threshold:.4});
    cards.forEach(c=> io.observe(c));

    // Also on primary CTA click
    document.querySelectorAll('.pricing button, .pricing a[role="button"], .pricing .cta')
      .forEach(btn=>{
        if(btn._tgWired) return; btn._tgWired = true;
        btn.addEventListener('click', (ev)=>{
          const card = btn.closest('.pricing [data-tier], .pricing .card, .pricing-card');
          if(card) makeSparkles(card, card.dataset.tier || 'basic', 24);
        }, {passive:true});
      });

    /* ---------- 5) Disable any old heavy confetti engines ---------- */
    document.documentElement.setAttribute('data-no-confetti','1');
    // If an older script exposed window.tgconfetti, pause it.
    if (window.tgconfetti && typeof window.tgconfetti.disable === 'function') {
      window.tgconfetti.disable();
    }

    /* ---------- 6) Clear section headings text where needed ---------- */
    // Make key section titles explicit if the template used generic labels.
    const fixTitles = [
      { sel: '.pricing h2, .pricing [data-section-title]', text: 'Monetise' },
      { sel: '#library h2, [data-section="library"] h2, .library h2', text: 'Library' },
      { sel: '#hero h2, [data-section="hero"] h2', text: 'Black & Gold — Creativity' }
    ];
    fixTitles.forEach(({sel,text})=>{
      const el = document.querySelector(sel);
      if (el && !el.dataset.lockTitle) { el.textContent = text; el.classList.add('tg-title'); }
    });

    console.info("%c" + TAG + " loaded.", "color:#FFD24D");
  } catch (e) {
    console.error("Patch v1.8 error:", e);
  }
})();
</script>
